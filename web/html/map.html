{{ template "page/head_start" .}}
{{ template "page/head_end" .}}

{{ template "page/body_start" .}}
<a-layout id="app" v-cloak :class="themeSwitcher.currentTheme + ' map-page'">
  <a-sidebar></a-sidebar>
  <a-layout id="content-layout">
    <a-layout-content>
      <div style="padding: 20px;">
        <a-page-header title="Map">
          <template slot="extra">
            <a-button icon="sync" @click="refresh">Refresh</a-button>
          </template>
        </a-page-header>
        <div style="margin-top: 20px;">
          <div id="world-map" style="width: 100%; height: 600px; border: 1px solid #d9d9d9; border-radius: 4px;"></div>
        </div>
      </div>
    </a-layout-content>
  </a-layout>
</a-layout>
{{template "page/body_scripts" .}}
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
{{template "component/aSidebar" .}}
{{template "component/aThemeSwitch" .}}
<script>
  const app = new Vue({
    delimiters: ['[[', ']]'],
    el: '#app',
    mixins: [MediaQueryMixin],
    data: {
      themeSwitcher,
      nodes: [],
      map: null,
      tiles: null,
      markers: [],
      markerCluster: null,
    },
    methods: {
      async refresh() {
        try {
          const msg = await HttpUtil.get('/panel/api/dashboard/map');
          if (msg.success) {
            this.nodes = (msg.obj || []).filter(n => n.latitude && n.longitude);
            this.renderMap();
          }
        } catch (e) {
          this.$message.error('Load failed');
        }
      },
      tileUrl() {
        const isDark = this.themeSwitcher.isDarkTheme;
        return isDark
          ? 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png'
          : 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png';
      },
      renderMap() {
        this.$nextTick(() => {
          const container = document.getElementById('world-map');
          if (!container) return;

          if (!this.map) {
            this.map = L.map('world-map', { zoomControl: true, worldCopyJump: true });
          }

          if (this.tiles) {
            this.map.removeLayer(this.tiles);
          }
          this.tiles = L.tileLayer(this.tileUrl(), {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> &copy; <a href="https://carto.com/attributions">CARTO</a>',
            maxZoom: 19
          });
          this.tiles.addTo(this.map);

          if (this.markerCluster) {
            this.map.removeLayer(this.markerCluster);
            this.markerCluster = null;
          }
          for (const m of this.markers) {
            if (this.map.hasLayer(m)) {
              this.map.removeLayer(m);
            }
          }
          this.markers = [];

          if (this.nodes.length === 0) {
            this.map.setView([20, 0], 2);
            return;
          }

          this.markerCluster = L.markerClusterGroup({
            maxClusterRadius: 50,
            spiderfyOnMaxZoom: true,
            showCoverageOnHover: false,
            zoomToBoundsOnClick: true,
          });

          const latlngs = [];
          for (const n of this.nodes) {
            const lat = parseFloat(n.latitude), lng = parseFloat(n.longitude);
            if (Number.isFinite(lat) && Number.isFinite(lng)) {
              latlngs.push([lat, lng]);
              const color = n.status === 'online' ? '#00a86b' : n.status === 'error' ? '#e46a76' : '#888888';
              const circle = L.circleMarker([lat, lng], {
                radius: 7,
                weight: 2,
                color: color,
                fillColor: color,
                fillOpacity: 0.85,
              });
              const popup = `<div style="min-width:200px;">
                <div style="margin-bottom: 8px;"><strong>${this._escape(n.name || 'Unnamed')}</strong></div>
                <div>Host: ${this._escape(n.host || 'N/A')}</div>
                <div>Status: ${n.status || 'unknown'}</div>
                ${n.city ? `<div>City: ${this._escape(n.city)}</div>` : ''}
                ${n.country ? `<div>Country: ${this._escape(n.country)}</div>` : ''}
              </div>`;
              circle.bindPopup(popup);
              this.markerCluster.addLayer(circle);
              this.markers.push(circle);
            }
          }

          if (this.markerCluster.getLayers().length > 0) {
            this.map.addLayer(this.markerCluster);
          }

          if (latlngs.length) {
            const bounds = L.latLngBounds(latlngs);
            this.map.fitBounds(bounds.pad(0.2));
          } else {
            this.map.setView([20, 0], 2);
          }
        });
      },
      _escape(s) {
        return String(s).replace(/[&<>"]/g, (c) => ({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[c]));
      }
    },
    computed: {
      currentTheme() {
        return this.themeSwitcher.currentTheme;
      }
    },
    watch: {
      currentTheme() {
        this.renderMap();
      }
    },
    mounted() {
      this.refresh();
    }
  });
</script>
{{ template "page/body_end" .}}
