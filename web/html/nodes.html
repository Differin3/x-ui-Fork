{{ template "page/head_start" .}}
{{ template "page/head_end" .}}

{{ template "page/body_start" .}}
<a-layout id="app" v-cloak :class="themeSwitcher.currentTheme + ' nodes-page'">
  <a-sidebar></a-sidebar>
  <a-layout id="content-layout">
    <a-layout-content>
      <a-spin :spinning="loadingStates.spinning" :delay="200" :tip="loadingTip">
        <a-row :gutter="[16,16]">
          <a-col :span="24">
            <a-page-header title="Ноды">
              <template slot="extra">
                <a-button type="primary" icon="plus" @click="openAdd">Добавить</a-button>
                <a-button icon="sync" @click="refresh">Обновить</a-button>
              </template>
            </a-page-header>
          </a-col>
          <a-col :span="24" v-if="showApiTip">
            <a-alert type="warning" show-icon message="Некоторые ноды не имеют API ключа"></a-alert>
          </a-col>
          <a-col :span="24">
            <a-table :data-source="nodes" :row-key="'id'" :pagination="false">
              <a-table-column title="ID" data-index="id" key="id"/>
              <a-table-column title="Название" data-index="name" key="name"/>
              <a-table-column title="Хост" data-index="host" key="host"/>
              <a-table-column title="Порт" data-index="port" key="port"/>
              <a-table-column title="Статус" key="status">
                <template slot-scope="text, record">
                  <a-tooltip :title="getStatusTooltip(record)">
                    <a-tag :color="getStatusColor(record.status)">
                      <a-icon :type="getStatusIcon(record.status)" style="margin-right: 4px"/>
                      [[ getStatusLabel(record.status) ]]
                    </a-tag>
                  </a-tooltip>
                </template>
              </a-table-column>
              <a-table-column title="Последняя проверка" key="lastCheck">
                <template slot-scope="text, record">
                  <span>[[ formatCheckTime(record.lastCheck) ]]</span>
                </template>
              </a-table-column>
              <a-table-column title="Примечание" data-index="remark" key="remark"/>
              <a-table-column title="Действия" key="action">
                <template slot-scope="text, record">
                  <a-space>
                    <a-tooltip title="Редактировать">
                      <a-button type="link" size="small" @click="openEdit(record)">
                        <a-icon type="edit"/>
                        <span style="margin-left: 4px">Редактировать</span>
                      </a-button>
                    </a-tooltip>
                    <a-divider type="vertical"/>
                    <a-tooltip title="Проверить статус">
                      <a-button type="link" size="small" @click="check(record)">
                        <a-icon type="check-circle"/>
                        <span style="margin-left: 4px">Проверить</span>
                      </a-button>
                    </a-tooltip>
                    <a-divider type="vertical"/>
                    <a-tooltip title="Синхронизировать">
                      <a-button type="link" size="small" @click="sync(record)">
                        <a-icon type="sync"/>
                        <span style="margin-left: 4px">Синхронизировать</span>
                      </a-button>
                    </a-tooltip>
                    <a-divider type="vertical"/>
                    <a-popconfirm title="Удалить ноду?" ok-text="Да" cancel-text="Нет" @confirm="del(record)">
                      <a-button type="link" size="small" danger slot="default">
                        <a-icon type="delete"/>
                        <span style="margin-left: 4px">Удалить</span>
                      </a-button>
                    </a-popconfirm>
                  </a-space>
                </template>
              </a-table-column>
            </a-table>
          </a-col>
        </a-row>

        <a-modal :visible="modals.edit.visible" title="Нода" :footer="null" @cancel="modals.edit.visible=false">
          <a-form :label-col="{span:6}" :wrapper-col="{span:16}">
            <a-form-item label="Название" :validate-status="v.name.status" :help="v.name.help"><a-input v-model="form.name" placeholder="Введите название"/></a-form-item>
            <a-form-item label="Хост" :validate-status="v.host.status" :help="v.host.help"><a-input v-model="form.host" placeholder="Введите хост"/></a-form-item>
            <a-form-item label="Порт" :validate-status="v.port.status" :help="v.port.help"><a-input-number v-model="form.port" :min="1" placeholder="Введите порт"/></a-form-item>
            <a-form-item label="Протокол" :validate-status="v.protocol.status" :help="v.protocol.help">
              <a-select v-model="form.protocol">
                <a-select-option value="https">https</a-select-option>
                <a-select-option value="http">http</a-select-option>
              </a-select>
            </a-form-item>
            <a-form-item label="API ключ"><a-input v-model="form.apiKey" placeholder="Введите API ключ"/></a-form-item>
            <a-form-item label="Местоположение"><a-input v-model="form.location" placeholder="Введите местоположение"/></a-form-item>
            <a-form-item label="Страна"><a-input v-model="form.country" placeholder="Введите страну"/></a-form-item>
            <a-form-item label="Город"><a-input v-model="form.city" placeholder="Введите город"/></a-form-item>
            <a-form-item label="Широта"><a-input-number v-model="form.latitude" :step="0.0001" placeholder="Введите широту" style="width: 100%;"/></a-form-item>
            <a-form-item label="Долгота">
              <a-input-number v-model="form.longitude" :step="0.0001" placeholder="Введите долготу" style="width: 100%;"/>
              <a-tooltip slot="extra" title="Определить местоположение по хосту">
                <a-button type="link" size="small" icon="environment" @click="detectLocation" :loading="detectingLocation">Определить</a-button>
              </a-tooltip>
            </a-form-item>
            <a-form-item label="Примечание"><a-textarea v-model="form.remark" placeholder="Введите примечание" :auto-size="{minRows:2,maxRows:4}"/></a-form-item>
            <a-form-item label="Включено"><a-switch v-model="form.enable"/></a-form-item>
            <a-form-item :wrapper-col="{span:16, offset:6}">
              <a-space>
                <a-button type="primary" @click="save">Сохранить</a-button>
                <a-button @click="modals.edit.visible=false">Отмена</a-button>
              </a-space>
            </a-form-item>
          </a-form>
        </a-modal>
      </a-spin>
    </a-layout-content>
  </a-layout>
</a-layout>
{{template "page/body_scripts" .}}
{{template "component/aSidebar" .}}
{{template "component/aThemeSwitch" .}}
<script>
  function removeVCloak() {
    const app = document.getElementById('app');
    if (app) {
      app.removeAttribute('v-cloak');
      app.style.display = '';
    }
  }
  
  if (typeof Vue === 'undefined') {
    console.error('Vue is not loaded');
    removeVCloak();
  } else if (typeof MediaQueryMixin === 'undefined') {
    console.error('MediaQueryMixin is not loaded');
    removeVCloak();
  } else if (typeof themeSwitcher === 'undefined') {
    console.error('themeSwitcher is not defined');
    removeVCloak();
  } else {
    try {
      const app = new Vue({
    delimiters: ['[[', ']]'],
    mixins: [MediaQueryMixin],
    el: '#app',
    data: {
      themeSwitcher,
      loadingStates: { fetched: false, spinning: false },
      loadingTip: 'Загрузка...',
      nodes: [],
      modals: { edit: { visible: false } },
      form: { id:null, name:'', host:'', port:5050, protocol:'https', apiKey:'', location:'', country:'', city:'', latitude:null, longitude:null, remark:'', enable:true },
      v: { name:{}, host:{}, port:{}, protocol:{} },
      detectingLocation: false,
    },
    computed:{
      showApiTip(){
        return this.nodes.some(n => !n.apiKey || n.apiKey.length===0)
      }
    },
    methods: {
      async refresh() {
        try {
          const msg = await HttpUtil.get('/panel/api/nodes/');
          if (msg.success) {
            this.nodes = (msg.obj || []).map(n => Object.assign({}, n));
          } else {
            this.$message.error('Ошибка загрузки');
          }
        } catch (e) {
          this.$message.error('Ошибка загрузки');
        }
      },
      openAdd(){ this.form = { id:null, name:'', host:'', port:5050, protocol:'https', apiKey:'', location:'', country:'', city:'', latitude:null, longitude:null, remark:'', enable:true }; this.clearValidation(); this.modals.edit.visible=true; },
      openEdit(r){ this.form = Object.assign({}, r); this.clearValidation(); this.modals.edit.visible=true; },
      clearValidation(){ this.v = { name:{}, host:{}, port:{}, protocol:{} }; },
      validate(){
        let ok = true; this.clearValidation();
        if(!this.form.name){ this.v.name={status:'error', help:'Обязательное поле'}; ok=false }
        if(!this.form.host){ this.v.host={status:'error', help:'Обязательное поле'}; ok=false }
        if(!this.form.port || this.form.port<1 || this.form.port>65535){ this.v.port={status:'error', help:'Неверный порт'}; ok=false }
        if(!['http','https'].includes(this.form.protocol)){ this.v.protocol={status:'error', help:'Неверный протокол'}; ok=false }
        return ok;
      },
      async save(){
        if(!this.validate()) return;
        let res;
        if(this.form.id){ res = await HttpUtil.post('/panel/api/nodes/'+this.form.id, this.form); }
        else{ res = await HttpUtil.post('/panel/api/nodes/', this.form); }
        if(res && res.success){ this.$message.success('Сохранено'); this.modals.edit.visible=false; this.refresh(); }
        else { this.$message.error('Ошибка сохранения'); }
      },
      async del(r){
        this.$confirm({
          title: 'Удалить ноду?',
          content: 'Вы уверены?',
          onOk: async () => {
            const res = await HttpUtil.post('/panel/api/nodes/'+r.id+'/delete');
            if(res.success){ this.$message.success('Удалено'); } else { this.$message.error('Ошибка удаления'); }
            this.refresh();
          }
        });
      },
      async check(r){ await HttpUtil.post('/panel/api/nodes/'+r.id+'/check'); this.refresh(); },
      async sync(r){ await HttpUtil.post('/panel/api/nodes/'+r.id+'/sync'); },
      async detectLocation(){
        if(!this.form.host){
          this.$message.warning('Хост обязателен');
          return;
        }
        this.detectingLocation = true;
        try {
          const nodeId = this.form.id || 0;
          const res = await HttpUtil.post('/panel/api/nodes/'+nodeId+'/detect-location', { host: this.form.host });
          if(res && res.success && res.obj){
            this.form.location = res.obj.location || '';
            this.form.country = res.obj.country || '';
            this.form.city = res.obj.city || '';
            this.form.latitude = res.obj.latitude || null;
            this.form.longitude = res.obj.longitude || null;
            this.$message.success('Местоположение определено');
          } else {
            this.$message.error('Ошибка определения местоположения');
          }
        } catch(e) {
          this.$message.error('Ошибка определения местоположения');
        } finally {
          this.detectingLocation = false;
        }
      },
      getStatusColor(status) {
        const s = (status || '').toLowerCase();
        if (s === 'online') return 'green';
        if (s === 'offline') return 'red';
        if (s === 'error') return 'orange';
        return 'default';
      },
      getStatusIcon(status) {
        const s = (status || '').toLowerCase();
        if (s === 'online') return 'check-circle';
        if (s === 'offline') return 'close-circle';
        if (s === 'error') return 'exclamation-circle';
        return 'question-circle';
      },
      getStatusLabel(status) {
        const s = (status || '').toLowerCase();
        if (s === 'online') return 'Онлайн';
        if (s === 'offline') return 'Офлайн';
        if (s === 'error') return 'Ошибка';
        return 'Неизвестно';
      },
      getStatusTooltip(r) {
        const status = (r.status || '').toLowerCase();
        let tip = '';
        if (status === 'online') tip = 'Нода онлайн';
        else if (status === 'offline') tip = 'Нода офлайн';
        else if (status === 'error') tip = 'Ошибка подключения';
        else tip = 'Статус неизвестен';
        if (r.lastCheck) {
          tip += `\nПроверено: ${this.formatCheckTime(r.lastCheck)}`;
        }
        return tip;
      },
      formatCheckTime(ts){
        if(!ts){ return 'Неизвестно'; }
        try {
          const date = new Date(ts * 1000);
          if(Number.isNaN(date.getTime())) return 'Неизвестно';
          return date.toLocaleString('ru-RU');
        } catch(e){
          return 'Неизвестно';
        }
      }
    },
    mounted(){
      this.loadingStates.fetched = true;
      const app = document.getElementById('app');
      if (app) {
        app.removeAttribute('v-cloak');
        app.style.display = '';
      }
      this.refresh();
    }
  });
    } catch (e) {
      console.error('Vue initialization failed:', e);
      removeVCloak();
    }
  }
</script>
{{ template "page/body_end" .}}
