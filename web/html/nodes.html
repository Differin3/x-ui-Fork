{{ template "page/head_start" .}}
{{ template "page/head_end" .}}

{{ template "page/body_start" .}}
<a-layout id="app" v-cloak :class="themeSwitcher.currentTheme + ' nodes-page'">
  <a-sidebar></a-sidebar>
  <a-layout id="content-layout">
    <a-layout-content>
      <a-spin :spinning="loadingStates.spinning" :delay="500" tip='{{ i18n "loading"}}'>
        <transition name="list" appear>
          <a-row v-if="!loadingStates.fetched">
            <a-card
              :style="{ textAlign: 'center', padding: '30px 0', marginTop: '10px', background: 'transparent', border: 'none' }">
              <a-spin tip='{{ i18n "loading" }}'></a-spin>
            </a-card>
          </a-row>
          <a-row :gutter="[isMobile ? 8 : 16, isMobile ? 0 : 12]" v-else>
            <a-col>
              <a-card hoverable>
                <a-page-header title='{{ i18n "pages.nodes.title"}}'>
                  <template slot="extra">
                    <a-space>
                      <a-button type="primary" icon="plus" @click="openAdd">{{ i18n "pages.nodes.add"}}</a-button>
                      <a-button icon="sync" @click="refresh" :loading="loadingStates.spinning">{{ i18n "pages.nodes.refresh"}}</a-button>
                    </a-space>
                  </template>
                </a-page-header>
                <a-alert v-if="showApiTip" type="warning" show-icon message='{{ i18n "pages.nodes.tipApiKey"}}' :style="{ marginTop: '16px' }"></a-alert>
                <a-table :data-source="nodes" :row-key="'id'" :pagination="false" :style="{ marginTop: '16px' }" size="middle">
              <a-table-column title='{{ i18n "pages.nodes.nodeId"}}' data-index="id" key="id"/>
              <a-table-column title='{{ i18n "pages.nodes.name"}}' data-index="name" key="name"/>
              <a-table-column title='{{ i18n "pages.nodes.host"}}' data-index="host" key="host"/>
              <a-table-column title='{{ i18n "pages.nodes.port"}}' data-index="port" key="port"/>
              <a-table-column title='{{ i18n "pages.nodes.status"}}' key="status">
                <template slot-scope="text, record">
                  <a-tooltip :title="getStatusTooltip(record)">
                    <a-tag :color="getStatusColor(record.status)">
                      <a-icon :type="getStatusIcon(record.status)" style="margin-right: 4px"/>
                      [[ getStatusLabel(record.status) ]]
                    </a-tag>
                  </a-tooltip>
                </template>
              </a-table-column>
              <a-table-column title='{{ i18n "pages.nodes.lastCheck"}}' key="lastCheck">
                <template slot-scope="text, record">
                  <span>[[ formatCheckTime(record.lastCheck) ]]</span>
                </template>
              </a-table-column>
              <a-table-column title='{{ i18n "pages.nodes.remark"}}' data-index="remark" key="remark"/>
              <a-table-column title='{{ i18n "pages.nodes.actions"}}' key="action">
                <template slot-scope="text, record">
                  <a-space>
                    <a-tooltip :title='{{ i18n "pages.nodes.edit"}}'>
                      <a-button type="link" size="small" icon="edit" @click="openEdit(record)">{{ i18n "pages.nodes.edit"}}</a-button>
                    </a-tooltip>
                    <a-divider type="vertical"/>
                    <a-tooltip :title='{{ i18n "pages.nodes.check"}}'>
                      <a-button type="link" size="small" icon="check-circle" @click="check(record)">{{ i18n "pages.nodes.check"}}</a-button>
                    </a-tooltip>
                    <a-divider type="vertical"/>
                    <a-tooltip :title='{{ i18n "pages.nodes.sync"}}'>
                      <a-button type="link" size="small" icon="sync" @click="sync(record)">{{ i18n "pages.nodes.sync"}}</a-button>
                    </a-tooltip>
                    <a-divider type="vertical"/>
                    <a-popconfirm :title='{{ i18n "deleteConfirm"}}' :ok-text='{{ i18n "yes"}}' :cancel-text='{{ i18n "no"}}' @confirm="del(record)">
                      <a-button type="link" size="small" danger icon="delete" slot="default">{{ i18n "pages.nodes.delete"}}</a-button>
                    </a-popconfirm>
                  </a-space>
                </template>
              </a-table-column>
            </a-table>
              </a-card>
            </a-col>
          </a-row>
        </transition>

        <a-modal :visible="modals.edit.visible" :title='{{ i18n "pages.nodes.title"}}' :footer="null" @cancel="modals.edit.visible=false">
          <a-form :label-col="{span:6}" :wrapper-col="{span:16}">
            <a-form-item :label='{{ i18n "pages.nodes.name"}}' :validate-status="v.name.status" :help="v.name.help"><a-input v-model="form.name" :placeholder='{{ i18n "pages.nodes.namePlaceholder"}}'/></a-form-item>
            <a-form-item :label='{{ i18n "pages.nodes.host"}}' :validate-status="v.host.status" :help="v.host.help"><a-input v-model="form.host" :placeholder='{{ i18n "pages.nodes.hostPlaceholder"}}'/></a-form-item>
            <a-form-item :label='{{ i18n "pages.nodes.port"}}' :validate-status="v.port.status" :help="v.port.help"><a-input-number v-model="form.port" :min="1" :placeholder='{{ i18n "pages.nodes.portPlaceholder"}}'/></a-form-item>
            <a-form-item :label='{{ i18n "pages.nodes.protocol"}}' :validate-status="v.protocol.status" :help="v.protocol.help">
              <a-select v-model="form.protocol">
                <a-select-option value="https">https</a-select-option>
                <a-select-option value="http">http</a-select-option>
              </a-select>
            </a-form-item>
            <a-form-item :label='{{ i18n "pages.nodes.apiKey"}}'><a-input v-model="form.apiKey" :placeholder='{{ i18n "pages.nodes.apiKeyPlaceholder"}}'/></a-form-item>
            <a-form-item :label='{{ i18n "pages.nodes.location"}}'><a-input v-model="form.location" :placeholder='{{ i18n "pages.nodes.locationPlaceholder"}}'/></a-form-item>
            <a-form-item :label='{{ i18n "pages.nodes.country"}}'><a-input v-model="form.country" :placeholder='{{ i18n "pages.nodes.countryPlaceholder"}}'/></a-form-item>
            <a-form-item :label='{{ i18n "pages.nodes.city"}}'><a-input v-model="form.city" :placeholder='{{ i18n "pages.nodes.cityPlaceholder"}}'/></a-form-item>
            <a-form-item :label='{{ i18n "pages.nodes.latitude"}}'><a-input-number v-model="form.latitude" :step="0.0001" :placeholder='{{ i18n "pages.nodes.latitudePlaceholder"}}' style="width: 100%;"/></a-form-item>
            <a-form-item :label='{{ i18n "pages.nodes.longitude"}}'>
              <a-input-number v-model="form.longitude" :step="0.0001" :placeholder='{{ i18n "pages.nodes.longitudePlaceholder"}}' style="width: 100%;"/>
              <a-tooltip slot="extra" :title='{{ i18n "pages.nodes.detectLocationTooltip"}}'>
                <a-button type="link" size="small" icon="environment" @click="detectLocation" :loading="detectingLocation">{{ i18n "pages.nodes.detectLocation"}}</a-button>
              </a-tooltip>
            </a-form-item>
            <a-form-item :label='{{ i18n "pages.nodes.remark"}}'><a-textarea v-model="form.remark" :placeholder='{{ i18n "pages.nodes.remarkPlaceholder"}}' :auto-size="{minRows:2,maxRows:4}"/></a-form-item>
            <a-form-item :label='{{ i18n "pages.nodes.enabled"}}'><a-switch v-model="form.enable"/></a-form-item>
            <a-form-item :wrapper-col="{span:16, offset:6}">
              <a-space>
                <a-button type="primary" @click="save">{{ i18n "update"}}</a-button>
                <a-button @click="modals.edit.visible=false">{{ i18n "cancel"}}</a-button>
              </a-space>
            </a-form-item>
          </a-form>
        </a-modal>
      </a-spin>
    </a-layout-content>
  </a-layout>
</a-layout>
{{template "page/body_scripts" .}}
{{template "component/aSidebar" .}}
{{template "component/aThemeSwitch" .}}
<script>
  const app = new Vue({
    delimiters: ['[[', ']]'],
    mixins: [MediaQueryMixin],
    el: '#app',
    data: {
      themeSwitcher,
      loadingStates: { fetched: false, spinning: false },
      nodes: [],
      modals: { edit: { visible: false } },
      form: { id:null, name:'', host:'', port:5050, protocol:'https', apiKey:'', location:'', country:'', city:'', latitude:null, longitude:null, remark:'', enable:true },
      v: { name:{}, host:{}, port:{}, protocol:{} },
      detectingLocation: false,
      t: {
        validationRequired: '{{ i18n "validation.required"}}',
        validationInvalidPort: '{{ i18n "validation.invalidPort"}}',
        validationInvalidProtocol: '{{ i18n "validation.invalidProtocol"}}',
        validationLoadFailed: '{{ i18n "validation.loadFailed"}}',
        validationSaveSuccess: '{{ i18n "validation.saveSuccess"}}',
        validationSaveFailed: '{{ i18n "validation.saveFailed"}}',
        deleteConfirm: '{{ i18n "deleteConfirm"}}',
        deleteConfirmDesc: '{{ i18n "deleteConfirmDesc"}}',
        statusOnline: '{{ i18n "pages.nodes.statusOnline"}}',
        statusOffline: '{{ i18n "pages.nodes.statusOffline"}}',
        statusError: '{{ i18n "pages.nodes.statusError"}}',
        statusUnknown: '{{ i18n "pages.nodes.statusUnknown"}}',
        statusTooltipOnline: '{{ i18n "pages.nodes.statusTooltipOnline"}}',
        statusTooltipOffline: '{{ i18n "pages.nodes.statusTooltipOffline"}}',
        statusTooltipError: '{{ i18n "pages.nodes.statusTooltipError"}}',
        statusTooltipUnknown: '{{ i18n "pages.nodes.statusTooltipUnknown"}}',
        statusTooltipCheckedAt: '{{ i18n "pages.nodes.statusTooltipCheckedAt"}}',
        detectLocationSuccess: '{{ i18n "pages.nodes.toasts.detectLocationSuccess"}}',
        detectLocation: '{{ i18n "pages.nodes.toasts.detectLocation"}}',
      }
    },
    computed:{
      showApiTip(){
        return this.nodes.some(n => !n.apiKey || n.apiKey.length===0)
      }
    },
    methods: {
      async refresh() {
        this.loadingStates.spinning = true;
        try {
          const msg = await HttpUtil.get('/panel/api/nodes/');
          if (msg.success) {
            this.nodes = (msg.obj || []).map(n => Object.assign({}, n));
          } else {
            this.$message.error(this.t.validationLoadFailed);
          }
        } catch (e) {
          this.$message.error(this.t.validationLoadFailed);
        } finally {
          this.loadingStates.spinning = false;
        }
      },
      openAdd(){ this.form = { id:null, name:'', host:'', port:5050, protocol:'https', apiKey:'', location:'', country:'', city:'', latitude:null, longitude:null, remark:'', enable:true }; this.clearValidation(); this.modals.edit.visible=true; },
      openEdit(r){ this.form = Object.assign({}, r); this.clearValidation(); this.modals.edit.visible=true; },
      clearValidation(){ this.v = { name:{}, host:{}, port:{}, protocol:{} }; },
      validate(){
        let ok = true; this.clearValidation();
        if(!this.form.name){ this.v.name={status:'error', help:this.t.validationRequired}; ok=false }
        if(!this.form.host){ this.v.host={status:'error', help:this.t.validationRequired}; ok=false }
        if(!this.form.port || this.form.port<1 || this.form.port>65535){ this.v.port={status:'error', help:this.t.validationInvalidPort}; ok=false }
        if(!['http','https'].includes(this.form.protocol)){ this.v.protocol={status:'error', help:this.t.validationInvalidProtocol}; ok=false }
        return ok;
      },
      async save(){
        if(!this.validate()) return;
        let res;
        if(this.form.id){ res = await HttpUtil.post('/panel/api/nodes/'+this.form.id, this.form); }
        else{ res = await HttpUtil.post('/panel/api/nodes/', this.form); }
        if(res && res.success){ this.$message.success(this.t.validationSaveSuccess); this.modals.edit.visible=false; this.refresh(); }
        else { this.$message.error(this.t.validationSaveFailed); }
      },
      async del(r){
        this.$confirm({
          title: this.t.deleteConfirm,
          content: this.t.deleteConfirmDesc,
          onOk: async () => {
            const res = await HttpUtil.post('/panel/api/nodes/'+r.id+'/delete');
            if(res.success){ this.$message.success(this.t.validationSaveSuccess); } else { this.$message.error(this.t.validationSaveFailed); }
            this.refresh();
          }
        });
      },
      async check(r){
        this.loadingStates.spinning = true;
        try {
          await HttpUtil.post('/panel/api/nodes/'+r.id+'/check');
          this.refresh();
        } finally {
          this.loadingStates.spinning = false;
        }
      },
      async sync(r){
        this.loadingStates.spinning = true;
        try {
          await HttpUtil.post('/panel/api/nodes/'+r.id+'/sync');
          this.refresh();
        } finally {
          this.loadingStates.spinning = false;
        }
      },
      async detectLocation(){
        if(!this.form.host){
          this.$message.warning(this.t.validationRequired);
          return;
        }
        this.detectingLocation = true;
        try {
          const nodeId = this.form.id || 0;
          const res = await HttpUtil.post('/panel/api/nodes/'+nodeId+'/detect-location', { host: this.form.host });
          if(res && res.success && res.obj){
            this.form.location = res.obj.location || '';
            this.form.country = res.obj.country || '';
            this.form.city = res.obj.city || '';
            this.form.latitude = res.obj.latitude || null;
            this.form.longitude = res.obj.longitude || null;
            this.$message.success(this.t.detectLocationSuccess);
          } else {
            this.$message.error(this.t.detectLocation);
          }
        } catch(e) {
          this.$message.error(this.t.detectLocation);
        } finally {
          this.detectingLocation = false;
        }
      },
      getStatusColor(status) {
        const s = (status || '').toLowerCase();
        if (s === 'online') return 'green';
        if (s === 'offline') return 'red';
        if (s === 'error') return 'orange';
        return 'default';
      },
      getStatusIcon(status) {
        const s = (status || '').toLowerCase();
        if (s === 'online') return 'check-circle';
        if (s === 'offline') return 'close-circle';
        if (s === 'error') return 'exclamation-circle';
        return 'question-circle';
      },
      getStatusLabel(status) {
        const s = (status || '').toLowerCase();
        if (s === 'online') return this.t.statusOnline;
        if (s === 'offline') return this.t.statusOffline;
        if (s === 'error') return this.t.statusError;
        return this.t.statusUnknown;
      },
      getStatusTooltip(r) {
        const status = (r.status || '').toLowerCase();
        let tip = '';
        if (status === 'online') tip = this.t.statusTooltipOnline;
        else if (status === 'offline') tip = this.t.statusTooltipOffline;
        else if (status === 'error') tip = this.t.statusTooltipError;
        else tip = this.t.statusTooltipUnknown;
        if (r.lastCheck) {
          tip += `\n${this.t.statusTooltipCheckedAt}${this.formatCheckTime(r.lastCheck)}`;
        }
        return tip;
      },
      formatCheckTime(ts){
        if(!ts){ return this.t.statusUnknown; }
        try {
          const date = new Date(ts * 1000);
          if(Number.isNaN(date.getTime())) return this.t.statusUnknown;
          return date.toLocaleString();
        } catch(e){
          return this.t.statusUnknown;
        }
      }
    },
    mounted(){
      this.loadingStates.fetched = true;
      this.refresh();
    }
  });
</script>
{{ template "page/body_end" .}}
