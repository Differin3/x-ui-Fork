{{ template "page/head_start" .}}
{{ template "page/head_end" .}}

{{ template "page/body_start" .}}
<a-layout id="app" v-cloak :class="themeSwitcher.currentTheme + ' multi-subscriptions-page'">
  <a-sidebar></a-sidebar>
  <a-layout id="content-layout">
    <a-layout-content>
      <div style="padding: 20px;">
        <a-page-header title="Multi Subscriptions">
          <template slot="extra">
            <a-button type="primary" icon="plus" @click="openAdd">Add</a-button>
            <a-button icon="sync" @click="refresh">Refresh</a-button>
          </template>
        </a-page-header>
        <a-table :data-source="items" :row-key="'id'" :pagination="false" style="margin-top: 20px;">
          <a-table-column title="ID" data-index="id" key="id"/>
          <a-table-column title="Name" data-index="name" key="name"/>
          <a-table-column title="Sub ID" data-index="subId" key="subId"/>
          <a-table-column title="Node IDs" key="nodeIds">
            <template slot-scope="text, record">
              <span>[[ formatNodeIds(record.nodeIds) ]]</span>
            </template>
          </a-table-column>
          <a-table-column title="Enabled" key="enable">
            <template slot-scope="text, record">
              <a-tag :color="record.enable ? 'green' : 'default'">
                [[ record.enable ? 'Yes' : 'No' ]]
              </a-tag>
            </template>
          </a-table-column>
          <a-table-column title="Remark" data-index="remark" key="remark"/>
          <a-table-column title="Actions" key="action">
            <template slot-scope="text, record">
              <a-button size="small" @click="openEdit(record)">Edit</a-button>
              <a-button size="small" @click="copySubUrl(record)">Copy URL</a-button>
              <a-button size="small" danger @click="del(record)">Delete</a-button>
            </template>
          </a-table-column>
        </a-table>
      </div>

      <a-modal :visible="modals.edit.visible" title="Multi Subscription" :footer="null" @cancel="modals.edit.visible=false">
        <a-form :label-col="{span:6}" :wrapper-col="{span:16}">
          <a-form-item label="Name" :validate-status="v.name.status" :help="v.name.help">
            <a-input v-model="form.name"/>
          </a-form-item>
          <a-form-item label="Sub ID" :validate-status="v.subId.status" :help="v.subId.help">
            <a-input v-model="form.subId"/>
          </a-form-item>
          <a-form-item label="Node IDs" :validate-status="v.nodeIds.status" :help="v.nodeIds.help">
            <a-textarea v-model="form.nodeIds" :auto-size="{minRows:3,maxRows:6}" placeholder='[1, 2, 3]'/>
          </a-form-item>
          <a-form-item label="Remark">
            <a-textarea v-model="form.remark" :auto-size="{minRows:2,maxRows:4}"/>
          </a-form-item>
          <a-form-item label="Enabled">
            <a-switch v-model="form.enable"/>
          </a-form-item>
          <a-form-item :wrapper-col="{span:16, offset:6}">
            <a-space>
              <a-button type="primary" @click="save">Save</a-button>
              <a-button @click="modals.edit.visible=false">Cancel</a-button>
            </a-space>
          </a-form-item>
        </a-form>
      </a-modal>
    </a-layout-content>
  </a-layout>
</a-layout>
{{template "page/body_scripts" .}}
{{template "component/aSidebar" .}}
{{template "component/aThemeSwitch" .}}
<script>
  const app = new Vue({
    delimiters: ['[[', ']]'],
    el: '#app',
    mixins: [MediaQueryMixin],
    data: {
      themeSwitcher,
      items: [],
      modals: { edit: { visible: false } },
      form: { id: null, name: '', subId: '', nodeIds: '[]', remark: '', enable: true },
      v: { name: {}, subId: {}, nodeIds: {} },
    },
    methods: {
      async refresh() {
        try {
          const msg = await HttpUtil.get('/panel/api/multi-subscriptions/');
          if (msg.success) {
            this.items = msg.obj || [];
          }
        } catch (e) {
          this.$message.error('Load failed');
        }
      },
      formatNodeIds(nodeIds) {
        if (typeof nodeIds === 'string') {
          try {
            nodeIds = JSON.parse(nodeIds);
          } catch (e) {
            return nodeIds;
          }
        }
        return Array.isArray(nodeIds) ? nodeIds.join(', ') : '';
      },
      openAdd() {
        this.form = { id: null, name: '', subId: '', nodeIds: '[]', remark: '', enable: true };
        this.clearValidation();
        this.modals.edit.visible = true;
      },
      openEdit(r) {
        this.form = Object.assign({}, r);
        if (typeof this.form.nodeIds !== 'string') {
          this.form.nodeIds = JSON.stringify(this.form.nodeIds || []);
        }
        this.clearValidation();
        this.modals.edit.visible = true;
      },
      clearValidation() {
        this.v = { name: {}, subId: {}, nodeIds: {} };
      },
      validate() {
        let ok = true;
        this.clearValidation();
        if (!this.form.name) {
          this.v.name = { status: 'error', help: 'Required' };
          ok = false;
        }
        if (this.form.subId && (this.form.subId.length < 3 || this.form.subId.length > 64)) {
          this.v.subId = { status: 'error', help: 'Invalid Sub ID' };
          ok = false;
        }
        try {
          const arr = JSON.parse(this.form.nodeIds || '[]');
          if (!Array.isArray(arr) || !arr.every(x => Number.isInteger(x))) {
            this.v.nodeIds = { status: 'error', help: 'Invalid Node IDs (must be JSON array of integers)' };
            ok = false;
          }
        } catch (e) {
          this.v.nodeIds = { status: 'error', help: 'Invalid JSON' };
          ok = false;
        }
        return ok;
      },
      async save() {
        if (!this.validate()) return;
        let res;
        const payload = Object.assign({}, this.form);
        try {
          payload.nodeIds = JSON.parse(this.form.nodeIds || '[]');
        } catch (e) {
          this.$message.error('Invalid Node IDs format');
          return;
        }
        if (this.form.id) {
          res = await HttpUtil.post('/panel/api/multi-subscriptions/' + this.form.id, payload);
        } else {
          res = await HttpUtil.post('/panel/api/multi-subscriptions/', payload);
        }
        if (res && res.success) {
          this.$message.success('Saved');
          this.modals.edit.visible = false;
          this.refresh();
        } else {
          this.$message.error('Save failed');
        }
      },
      async del(r) {
        this.$confirm({
          title: 'Delete?',
          content: 'Are you sure?',
          onOk: async () => {
            const res = await HttpUtil.post('/panel/api/multi-subscriptions/' + r.id + '/delete');
            if (res.success) {
              this.$message.success('Deleted');
            } else {
              this.$message.error('Delete failed');
            }
            this.refresh();
          }
        });
      },
      async copySubUrl(r) {
        try {
          const res = await HttpUtil.get('/panel/api/multi-subscriptions/' + r.id + '/subscription-url');
          if (res && res.success && res.obj && res.obj.url) {
            await navigator.clipboard.writeText(res.obj.url);
            this.$message.success('URL copied');
          } else {
            this.$message.error('Failed to get URL');
          }
        } catch (e) {
          this.$message.error('Failed to copy URL');
        }
      }
    },
    mounted() {
      this.refresh();
    }
  });
</script>
{{ template "page/body_end" .}}
